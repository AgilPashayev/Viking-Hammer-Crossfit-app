name: Supabase Deploy

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install supabase CLI (official)
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y jq ca-certificates curl tar
          TAG=$(curl -s https://api.github.com/repos/supabase/cli/releases/latest | jq -r .tag_name)
          URL="https://github.com/supabase/cli/releases/download/${TAG}/supabase_linux_amd64.tar.gz"
          echo "Downloading $URL"
          curl -sL "$URL" -o supabase.tgz
          ls -l supabase.tgz
          file supabase.tgz || true
          tar -xzf supabase.tgz
          sudo mv supabase /usr/local/bin/supabase
          sudo chmod +x /usr/local/bin/supabase
          supabase --version

      - name: Set up PowerShell
        uses: PowerShell/PowerShell@v3
        with:
          enablePSRemoting: false

      - name: Run supabase deploy script
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          pwsh -NoLogo -NoProfile -NonInteractive ./infra/supabase/run_deploy_locally.ps1
